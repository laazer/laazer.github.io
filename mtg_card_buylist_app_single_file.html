<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MTG Buylist Builder</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.15);
      --glass-border: rgba(255, 255, 255, 0.35);
      --accent: #7dd3fc;
      --accent-strong: #38bdf8;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Inter, system-ui, sans-serif;
      background: radial-gradient(1200px at top left, #1e293b, #020617);
      color: var(--text);
      margin: 0; padding: 24px;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(14px) saturate(160%);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    .layout { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
    textarea, input[type="text"] {
      width: 100%; background: rgba(0,0,0,0.35); border: 1px solid var(--glass-border);
      color: var(--text); border-radius: 10px; padding: 10px; font-family: monospace;
    }
    button, select {
      padding: 8px 14px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #020617; font-weight: 600; cursor: pointer;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.9rem; }
    th, td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.15); }
    th { cursor: pointer; color: #bae6fd; }
    tr:hover { background: rgba(255,255,255,0.08); }
    input.qty { width: 60px; text-align: center; }
    .price { text-align: right; }
    .controls, .top-controls {
      display: flex; gap: 8px; justify-content: space-between; align-items: center; margin-top: 12px;
    }
    .pagination { display: flex; gap: 6px; align-items: center; }
    .image-panel img { width: 100%; border-radius: 12px; display: none; }
  </style>
</head>
<body>

<h1>ðŸ§™ MTG Buylist Builder</h1>
<p>Multiple saved lists, search, and bulk actions.</p>

<div class="top-controls glass" style="padding:12px; margin-bottom:12px;">
  <select id="listSelect" onchange="loadList()"></select>
  <input id="newListName" type="text" placeholder="New list name" />
  <button onclick="createList()">New</button>
  <button onclick="deleteList()">Delete List</button>
</div>

<div class="layout">
  <div class="glass" style="padding:16px;">
    <textarea id="deckList" placeholder="1 Sol Ring
2 Forest"></textarea>
    <div class="controls">
      <button onclick="parseDeckList()">Parse</button>
      <input id="search" type="text" placeholder="Search cards" oninput="render()" />
      <button onclick="bulkDelete()">Delete Selected</button>
    </div>

    <table>
      <thead>
        <tr>
          <th><input type="checkbox" onclick="toggleAll(this)"></th>
          <th onclick="sortBy('name')">Card</th>
          <th onclick="sortBy('qty')">Qty</th>
          <th onclick="sortBy('price')" class="price">USD</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="cardTable"></tbody>
    </table>

    <div class="controls">
      <div class="pagination">
        Rows <select id="pageSize" onchange="render()"><option>10</option><option>25</option><option>50</option><option>100</option><option>250</option></select>
        <button onclick="page=Math.max(0,page-1);render()">â—€</button>
        <button onclick="page++;render()">â–¶</button>
      </div>
      <div><strong>Total: $<span id="total">0.00</span></strong></div>
      <button onclick="exportCSV()">Export</button>
    </div>
  </div>

  <div class="glass image-panel" style="padding:16px;">
    <div id="imgHint">Hover a card<br>to preview art</div>
    <img id="cardImage" />
  </div>
</div>

<script>
  let state = JSON.parse(localStorage.getItem('mtgLists') || '{}');
  let current = Object.keys(state)[0] || 'Default';
  state[current] ||= [];

  let sortKey='name', sortDir=1, page=0;
  const table=document.getElementById('cardTable');
  const totalEl=document.getElementById('total');

  function save(){ localStorage.setItem('mtgLists', JSON.stringify(state)); }

  function refreshListSelect(){
    listSelect.innerHTML='';
    Object.keys(state).forEach(k=>{
      const o=document.createElement('option'); o.value=o.textContent=k;
      if(k===current) o.selected=true;
      listSelect.appendChild(o);
    });
  }

  function loadList(){ current=listSelect.value; page=0; render(); }

  function createList(){
    const n=newListName.value.trim(); if(!n||state[n])return;
    state[n]=[]; current=n; newListName.value=''; save(); refreshListSelect(); render();
  }

  function deleteList(){
    if(!confirm('Delete list?')) return;
    delete state[current];
    current=Object.keys(state)[0]||'Default';
    state[current] ||= [];
    save(); refreshListSelect(); render();
  }

  function parseDeckList(){
    const map={};
    deckList.value.split(/\n+/).forEach(l=>{
      const m=l.match(/^(\d+)\s+(.+)$/); if(!m)return;
      map[m[2]]=(map[m[2]]||0)+Number(m[1]);
    });
    state[current]=Object.entries(map).map(([name,qty])=>({
      id: crypto.randomUUID(),
      name, qty, price:null, sel:true
    }));
    state[current].forEach(loadPrice); save(); render();
  }

  async function loadPrice(c){
    try{
      const r=await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(c.name)}`);
      const d=await r.json();
      c.price=d.prices?.usd?Number(d.prices.usd):null;
      save(); render();
    }catch{}
  }

  function render(){
    table.innerHTML='';
    const cards=state[current]
      .filter(c=>c.name.toLowerCase().includes(search.value.toLowerCase()));

    cards.sort((a,b)=>a[sortKey]>b[sortKey]?sortDir:-sortDir);
    const size=Number(pageSize.value);

    cards.slice(page*size,page*size+size).forEach(c=>{
      const r=document.createElement('tr');
      r.innerHTML=`
        <td><input type=checkbox ${c.sel?'checked':''} onchange="c.sel=this.checked;save();updateTotal()"></td>
        <td>${c.name}</td>
        <td><input class=qty type=number value=${c.qty} onchange="c.qty=this.value;save();updateTotal()"></td>
        <td class=price>${c.price?c.price.toFixed(2):'â€”'}</td>
        <td><button onclick="deleteCard('${c.id}')">âœ•</button></td>`;
      r.onmouseenter=()=>showImage(c.name);
      table.appendChild(r);
    });

    updateTotal(); refreshListSelect(); save();
  }

  function deleteCard(id){
    state[current]=state[current].filter(c=>c.id!==id);
    save(); render();
  }

  function sortBy(k){ sortDir=sortKey===k?-sortDir:1; sortKey=k; render(); }
  function toggleAll(e){ state[current].forEach(c=>c.sel=e.checked); save(); render(); }
  function bulkDelete(){ state[current]=state[current].filter(c=>!c.sel); save(); render(); }

  function updateTotal(){
    let t=0;
    state[current].forEach(c=>{ if(c.sel&&c.price)t+=c.qty*c.price; });
    totalEl.textContent=t.toFixed(2);
  }

  async function showImage(n){
    const r=await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(n)}`);
    const d=await r.json();
    cardImage.src=d.image_uris.normal;
    cardImage.style.display='block';
    imgHint.style.display='none';
  }

  function exportCSV(){
    let csv='Name,Qty,Price\n';
    state[current].forEach(c=>csv+=`${c.name},${c.qty},${c.price??''}\n`);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download=`${current}.csv`;
    a.click();
  }

  refreshListSelect(); render();
</script>
</body>
</html>
